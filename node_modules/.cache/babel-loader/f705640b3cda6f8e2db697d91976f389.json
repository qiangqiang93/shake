{"remainingRequest":"/Users/qiang/work/hytx/hytx-rebuild/node_modules/babel-loader/lib/index.js!/Users/qiang/work/hytx/hytx-rebuild/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/qiang/work/hytx/hytx-rebuild/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/qiang/work/hytx/hytx-rebuild/src/module/marketing/edit/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/qiang/work/hytx/hytx-rebuild/src/module/marketing/edit/index.vue","mtime":1547013755438},{"path":"/Users/qiang/work/hytx/hytx-rebuild/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/qiang/work/hytx/hytx-rebuild/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/qiang/work/hytx/hytx-rebuild/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/qiang/work/hytx/hytx-rebuild/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/es6.object.assign\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"/Users/qiang/work/hytx/hytx-rebuild/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _objectSpread from \"/Users/qiang/work/hytx/hytx-rebuild/node_modules/@babel/runtime/helpers/esm/objectSpread\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { mapState, mapActions } from 'vuex';\nimport marketing from '../../../api/marketing';\nimport Wrapper from '../../../components/Wrapper';\nimport validate from '../../../utils/validate.js';\nimport dialogService from '../../../service/dialogService';\nimport AppUploadImg from '../../../components/AppUploadImg';\nimport AndroidHeader from '../../../components/AndroidHeader';\nexport default {\n  name: 'marketingEdit',\n  data: function data() {\n    return {\n      inputs: {\n        title: '',\n        content: [],\n        superLink: {\n          href: '',\n          btnText: ''\n        },\n        contact: {\n          name: '',\n          phone: ''\n        }\n      },\n      isSave: false,\n      emptyTemp: null\n    };\n  },\n  mounted: function mounted() {\n    var cache = JSON.parse(this.cache.contents);\n    this.emptyTemp = JSON.stringify(cache);\n\n    if (cache) {\n      this.inputs = cache;\n    }\n  },\n  methods: _objectSpread({}, mapActions(['marketing/setCache', 'system/updateCropper', 'system/updateRouter']), {\n    // 添加板块\n    addBlock: function addBlock(type) {\n      var item;\n\n      if (type === 'img') {\n        item = {\n          src: '',\n          type: 'img'\n        };\n      } else {\n        item = {\n          text: '',\n          type: 'text'\n        };\n      }\n\n      this.inputs.content.push(item);\n    },\n    // 删除板块\n    delBlock: function delBlock(index) {\n      this.inputs.content.splice(index, 1);\n    },\n    // 上传图片\n    upload: function upload(path, index) {\n      this.$set(this.inputs.content[index], 'src', path);\n    },\n    // 预览\n    preview: function preview() {\n      this['marketing/setCache'](this.inputs);\n      this.$router.push('/marketing/preview');\n    },\n    // 保存\n    submit: function () {\n      var _submit = _asyncToGenerator(\n      /*#__PURE__*/\n      regeneratorRuntime.mark(function _callee() {\n        var _self, validateContent, validateConcatInfo, inputs, res;\n\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.prev = 0;\n                _self = this;\n                validateContent = this.validateContent();\n                validateConcatInfo = this.validateConcatInfo();\n\n                if (!validateContent) {\n                  _context.next = 6;\n                  break;\n                }\n\n                throw new Error(validateContent);\n\n              case 6:\n                if (!validateConcatInfo) {\n                  _context.next = 8;\n                  break;\n                }\n\n                throw new Error(validateConcatInfo);\n\n              case 8:\n                // 全部通过删除掉无效的数据\n                inputs = Object.assign({}, this.inputs);\n                inputs.content = inputs.content.filter(function (item) {\n                  return item.type === 'img' && item.src || item.type === 'text' && item.text;\n                });\n                _context.next = 12;\n                return marketing.editMarketing(this.cache.id, {\n                  title: inputs.title,\n                  contents: JSON.stringify(inputs)\n                });\n\n              case 12:\n                res = _context.sent;\n\n                if (!(res.status !== 0)) {\n                  _context.next = 15;\n                  break;\n                }\n\n                throw new Error(res.message);\n\n              case 15:\n                dialogService.alert('编辑成功', function () {\n                  _self.isSave = true;\n\n                  _self.$router.back();\n                });\n                _context.next = 21;\n                break;\n\n              case 18:\n                _context.prev = 18;\n                _context.t0 = _context[\"catch\"](0);\n                dialogService.alert(_context.t0.message);\n\n              case 21:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[0, 18]]);\n      }));\n\n      function submit() {\n        return _submit.apply(this, arguments);\n      }\n\n      return submit;\n    }(),\n    // 校验内容数据\n    validateContent: function validateContent() {\n      try {\n        // title不能为空\n        if (!this.inputs.title) {\n          throw new Error('标题不能为空，请输入标题');\n        } // 没有一个营销内容 || 所有营销内容都为空\n\n\n        if (!this.inputs.content.length) {\n          throw new Error('您还没有输入任何内容，请先添加营销内容');\n        }\n\n        var empty = this.inputs.content.every(function (item) {\n          return item.type === 'img' && !item.src || item.type === 'text' && !item.text;\n        });\n\n        if (empty) {\n          throw new Error('您还没有输入任何内容，请先添加营销内容');\n        }\n      } catch (err) {\n        return err.message;\n      }\n    },\n    // 是否有联系方式\n    validateConcatInfo: function validateConcatInfo() {\n      if (!(this.inputs.contact.name && this.inputs.contact.phone) && !(this.inputs.superLink.btnText && this.inputs.superLink.href)) {\n        return '网址和联系方式至少填写一个（按钮和链接或者联系人姓名和电话）';\n      }\n\n      if (this.inputs.contact.name && this.inputs.contact.phone) {\n        var res = validate.phone(this.inputs.contact.phone);\n        if (!res.status) return res.msg;\n      } //   网址验证不准确,暂时放弃网址验证\n      //   if (this.inputs.superLink.btnText && this.inputs.superLink.href) {\n      //     let res = validate.website(this.inputs.superLink.href)\n      //     if (!res.status) return res.msg\n      //   }\n\n\n      if (/^http:\\/\\/|^https:\\/\\//.test(this.inputs.superLink.href)) {\n        this.inputs.superLink.href = 'http://' + this.inputs.superLink.href;\n      }\n    }\n  }),\n  // 离开前检查是否编辑\n  beforeRouteLeave: function beforeRouteLeave(to, from, next) {\n    var _self = this;\n\n    var isEdit = this.emptyTemp !== JSON.stringify(this.inputs);\n\n    if (to.path === '/cropper') {\n      next(true);\n    } else if (to.path === '/marketing/preview') {\n      next(true);\n    } else if (isEdit && !this.isSave) {\n      next(false);\n      dialogService.confirm('你还没保存,你确定要离开', function () {\n        _self['system/updateRouter']({\n          type: 'del',\n          data: 'marketingCreate'\n        });\n\n        _self['marketing/setCache'](null);\n\n        next(true);\n      });\n    } else {\n      next(true);\n    }\n  },\n  components: {\n    Wrapper: Wrapper,\n    AppUploadImg: AppUploadImg,\n    AndroidHeader: AndroidHeader\n  },\n  computed: _objectSpread({}, mapState({\n    cache: function cache(state) {\n      return state.marketing.cache;\n    },\n    platform: function platform(state) {\n      return state.system.platform;\n    },\n    marketings: function marketings(state) {\n      return state.marketing.marketings;\n    }\n  }), {\n    paddingTop: function paddingTop() {\n      return this.platform === 'wechat' ? '0px' : '100px';\n    }\n  })\n};",{"version":3,"sources":["index.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <Wrapper class=\"marketing-edit-wrapper\" :paddingTop=\"paddingTop\">\n    <AndroidHeader ref=\"header\" title=\"编辑营销网页\" iconColor=\"#fff\" fontColor=\"#fff\" background=\"#000\"></AndroidHeader>\n    <div class=\"marketing-container\">\n      <div class=\"marketing-wrapper\">\n        <p class=\"marketing-title\">\n          <i class=\"iconfont icon-tianxie\"></i>\n          <span>输入标题</span>\n        </p>\n        <p class=\"marketing-input-box\">\n          <input class=\"input\" type=\"text\" v-model=\"inputs.title\" placeholder=\"请输入标题（20字以内）\" maxlength=\"20\">\n        </p>\n      </div>\n      <div class=\"content-wrapper\">\n        <p class=\"title\">\n          <i class=\"iconfont icon-tuwen1\"></i>\n          <span>图文内容</span>\n        </p>\n        <div class=\"input-wrapper\">\n          <div class=\"input-box\" v-for=\"(item, index) in inputs.content\" :key=\"index\">\n            <div class=\"input-img\" v-if=\"item.type === 'img'\">\n              <img class=\"img\" v-if=\"item.src\" :src=\"item.src\" alt=\"\">\n              <div class=\"input-file\" v-else>\n                <AppUploadImg class=\"input\" @success=\"upload($event, index)\"></AppUploadImg>\n              </div>\n            </div>\n            <div class=\"input-text\" v-else>\n              <textarea v-model=\"item.text\" placeholder=\"请输入产品广告语，限50字\" maxlength=\"50\"></textarea>\n            </div>\n            <div class=\"delete\" @click=\"delBlock(index)\">×</div>\n          </div>\n        </div>\n        <div class=\"btn-group\">\n          <button type=\"button\" @click=\"addBlock('img')\">\n            <i class=\"iconfont icon-jiatupian\"></i>\n            <span>图片</span>\n          </button>\n          <button type=\"button\" @click=\"addBlock('txt')\">\n            <i class=\"iconfont icon-tianjiawenzi\"></i>\n            <span>文字</span>\n          </button>\n        </div>\n      </div>\n      <div class=\"marketing-wrapper\">\n        <p class=\"marketing-title\">\n          <i class=\"iconfont icon-waibulianjie\"></i>\n          <span>外部链接</span>\n        </p>\n        <p class=\"marketing-input-box\">\n          <input class=\"input\" type=\"text\" v-model=\"inputs.superLink.btnText\" placeholder=\"按钮名称\" maxlength=\"8\">\n        </p>\n        <p class=\"marketing-input-box\">\n          <input class=\"input\" type=\"text\" v-model=\"inputs.superLink.href\" placeholder=\"外部链接\">\n        </p>\n      </div>\n      <div class=\"marketing-wrapper\">\n        <p class=\"marketing-title\">\n          <i class=\"iconfont icon-lianxifangshi\"></i>\n          <span>联系方式</span>\n        </p>\n        <p class=\"marketing-input-box\">\n          <input class=\"input\" type=\"text\" v-model=\"inputs.contact.name\" placeholder=\"联系人姓名\">\n        </p>\n        <p class=\"marketing-input-box\">\n          <input class=\"input\" type=\"text\" v-model=\"inputs.contact.phone\" placeholder=\"联系人方式\">\n        </p>\n      </div>\n      <div ref=\"footer\" class=\"foot\">\n        <button type=\"button\" @click=\"preview()\">预览</button>\n        <button type=\"button\" @click=\"submit()\">保存</button>\n      </div>\n    </div>\n  </Wrapper>\n</template>\n\n<script>\nimport { mapState, mapActions } from 'vuex'\nimport marketing from '../../../api/marketing'\nimport Wrapper from '../../../components/Wrapper'\nimport validate from '../../../utils/validate.js'\nimport dialogService from '../../../service/dialogService'\nimport AppUploadImg from '../../../components/AppUploadImg'\nimport AndroidHeader from '../../../components/AndroidHeader'\nexport default {\n  name: 'marketingEdit',\n  data() {\n    return {\n      inputs: {\n        title: '',\n        content: [],\n        superLink: {\n          href: '',\n          btnText: ''\n        },\n        contact: {\n          name: '',\n          phone: ''\n        }\n      },\n      isSave: false,\n      emptyTemp: null\n    }\n  },\n  mounted() {\n    let cache = JSON.parse(this.cache.contents)\n    this.emptyTemp = JSON.stringify(cache)\n    if (cache) {\n      this.inputs = cache\n    }\n  },\n  methods: {\n    ...mapActions([\n      'marketing/setCache',\n      'system/updateCropper',\n      'system/updateRouter'\n    ]),\n    // 添加板块\n    addBlock(type) {\n      let item\n      if (type === 'img') {\n        item = {\n          src: '',\n          type: 'img'\n        }\n      } else {\n        item = {\n          text: '',\n          type: 'text'\n        }\n      }\n      this.inputs.content.push(item)\n    },\n    // 删除板块\n    delBlock(index) {\n      this.inputs.content.splice(index, 1)\n    },\n    // 上传图片\n    upload(path, index) {\n      this.$set(this.inputs.content[index], 'src', path)\n    },\n    // 预览\n    preview() {\n      this['marketing/setCache'](this.inputs)\n      this.$router.push('/marketing/preview')\n    },\n    // 保存\n    async submit() {\n      // 先验证内容是否为空\n      try {\n        let _self = this\n        let validateContent = this.validateContent()\n        let validateConcatInfo = this.validateConcatInfo()\n        if (validateContent) throw new Error(validateContent)\n        if (validateConcatInfo) throw new Error(validateConcatInfo)\n        // 全部通过删除掉无效的数据\n        let inputs = Object.assign({}, this.inputs)\n        inputs.content = inputs.content.filter(\n          item =>\n            (item.type === 'img' && item.src) ||\n            (item.type === 'text' && item.text)\n        )\n        let res = await marketing.editMarketing(this.cache.id, {\n          title: inputs.title,\n          contents: JSON.stringify(inputs)\n        })\n        if (res.status !== 0) throw new Error(res.message)\n        dialogService.alert('编辑成功', function() {\n          _self.isSave = true\n          _self.$router.back()\n        })\n      } catch (err) {\n        dialogService.alert(err.message)\n      }\n    },\n    // 校验内容数据\n    validateContent() {\n      try {\n        // title不能为空\n        if (!this.inputs.title) {\n          throw new Error('标题不能为空，请输入标题')\n        }\n        // 没有一个营销内容 || 所有营销内容都为空\n        if (!this.inputs.content.length) {\n          throw new Error('您还没有输入任何内容，请先添加营销内容')\n        }\n        let empty = this.inputs.content.every(\n          item =>\n            (item.type === 'img' && !item.src) ||\n            (item.type === 'text' && !item.text)\n        )\n        if (empty) {\n          throw new Error('您还没有输入任何内容，请先添加营销内容')\n        }\n      } catch (err) {\n        return err.message\n      }\n    },\n    // 是否有联系方式\n    validateConcatInfo() {\n      if (\n        !(this.inputs.contact.name && this.inputs.contact.phone) &&\n        !(this.inputs.superLink.btnText && this.inputs.superLink.href)\n      ) {\n        return '网址和联系方式至少填写一个（按钮和链接或者联系人姓名和电话）'\n      }\n      if (this.inputs.contact.name && this.inputs.contact.phone) {\n        let res = validate.phone(this.inputs.contact.phone)\n        if (!res.status) return res.msg\n      }\n      //   网址验证不准确,暂时放弃网址验证\n      //   if (this.inputs.superLink.btnText && this.inputs.superLink.href) {\n      //     let res = validate.website(this.inputs.superLink.href)\n      //     if (!res.status) return res.msg\n      //   }\n      if (/^http:\\/\\/|^https:\\/\\//.test(this.inputs.superLink.href)) {\n        this.inputs.superLink.href = 'http://' + this.inputs.superLink.href\n      }\n    }\n  },\n  // 离开前检查是否编辑\n  beforeRouteLeave(to, from, next) {\n    let _self = this\n    let isEdit = this.emptyTemp !== JSON.stringify(this.inputs)\n    if (to.path === '/cropper') {\n      next(true)\n    } else if (to.path === '/marketing/preview') {\n      next(true)\n    } else if (isEdit && !this.isSave) {\n      next(false)\n      dialogService.confirm('你还没保存,你确定要离开', function() {\n        _self['system/updateRouter']({ type: 'del', data: 'marketingCreate' })\n        _self['marketing/setCache'](null)\n        next(true)\n      })\n    } else {\n      next(true)\n    }\n  },\n  components: {\n    Wrapper,\n    AppUploadImg,\n    AndroidHeader\n  },\n  computed: {\n    ...mapState({\n      cache: state => state.marketing.cache,\n      platform: state => state.system.platform,\n      marketings: state => state.marketing.marketings\n    }),\n    paddingTop: function() {\n      return this.platform === 'wechat' ? '0px' : '100px'\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.marketing-edit-wrapper {\n  padding-bottom: 124px;\n  background: rgba(201, 201, 211, 0.1);\n}\n.marketing-container {\n  overflow: hidden;\n  padding: 32px 25px;\n  box-sizing: border-box;\n}\n.marketing-wrapper {\n  width: 700px;\n  height: auto;\n  overflow: hidden;\n  margin-bottom: 20px;\n  border-radius: 12px;\n  padding-bottom: 20px;\n  background: rgba(255, 255, 255, 1);\n  box-shadow: 0px 12px 12px rgba(227, 237, 250, 1);\n  .marketing-title {\n    font-size: 36px;\n    overflow: hidden;\n    font-weight: 500;\n    line-height: 50px;\n    text-align: center;\n    font-family: PingFang SC;\n    color: rgba(39, 79, 243, 1);\n  }\n  .icon-tianxie,\n  .icon-waibulianjie,\n  .icon-lianxifangshi {\n    display: block;\n    font-size: 44px;\n    margin: 26px auto 6px;\n  }\n  .marketing-input-box {\n    width: 640px;\n    height: 84px;\n    margin: 20px auto 40px;\n  }\n  .input {\n    width: 100%;\n    height: 100%;\n    outline: none;\n    display: block;\n    padding: 0 40px;\n    font-size: 28px;\n    line-height: 84px;\n    border-radius: 12px;\n    box-sizing: border-box;\n    background: rgba(249, 249, 250, 1);\n  }\n}\n.content-wrapper {\n  width: 700px;\n  height: auto;\n  padding: 30px;\n  margin: 20px 0;\n  overflow: hidden;\n  background: #fff;\n  border-radius: 12px;\n  box-sizing: border-box;\n  box-shadow: 0px 12px 12px rgba(227, 237, 250, 1);\n  .title {\n    font-size: 36px;\n    font-weight: 500;\n    overflow: hidden;\n    line-height: 50px;\n    text-align: center;\n    font-family: PingFang SC;\n    color: rgba(39, 79, 243, 1);\n  }\n  .icon-tuwen1 {\n    display: block;\n    font-size: 44px;\n    margin: 0 auto 5px;\n  }\n  .input-wrapper {\n    overflow: hidden;\n  }\n  .input-box {\n    width: 100%;\n    overflow: hidden;\n    margin-top: 20px;\n    position: relative;\n    border-radius: 12px;\n    box-sizing: border-box;\n    .delete {\n      top: 0;\n      right: 0;\n      width: 56px;\n      height: 56px;\n      color: #fff;\n      font-size: 42px;\n      text-indent: 8px;\n      line-height: 40px;\n      text-align: center;\n      position: absolute;\n      background: #555555;\n      border-bottom-left-radius: 56px;\n    }\n  }\n  .input-img {\n    width: 100%;\n    overflow: hidden;\n    position: relative;\n    box-sizing: border-box;\n    border: 1px solid #e1e8ef;\n    .img {\n      width: 100%;\n    }\n    .input-file {\n      width: 100%;\n      height: 320px;\n      background-size: cover;\n      background-position: center;\n      background-image: url(./addImg.jpg);\n    }\n    .input {\n      opacity: 0;\n      width: 100%;\n      height: 320px;\n      display: block;\n    }\n  }\n  .input-text {\n    font-size: 30px;\n    overflow: hidden;\n    line-height: 48px;\n    box-sizing: border-box;\n    border: 1px solid #e1e8ef;\n    textarea {\n      margin: 0;\n      width: 100%;\n      height: 165px;\n      resize: none;\n      outline: none;\n      display: block;\n      padding: 0 15px;\n      font-size: 30px;\n      overflow: hidden;\n      line-height: 60px;\n      text-align: justify;\n      word-wrap: break-word;\n      word-break: break-all;\n      box-sizing: border-box;\n    }\n  }\n  .btn-group {\n    display: flex;\n    overflow: hidden;\n    margin: 48px 0 64px;\n    justify-content: space-between;\n    button {\n      padding: 0;\n      float: left;\n      width: 298px;\n      height: 84px;\n      outline: none;\n      display: flex;\n      font-size: 36px;\n      align-items: center;\n      border-radius: 12px;\n      background: #ffffff;\n      justify-content: center;\n      font-family: 'PingFang SC';\n      color: rgba(72, 79, 100, 1);\n      border: 2px solid rgba(235, 235, 235, 1);\n    }\n    .icon-jiatupian {\n      font-size: 44px;\n      margin-right: 12px;\n    }\n    .icon-tianjiawenzi {\n      font-size: 36px;\n      margin-right: 12px;\n    }\n  }\n}\n.foot {\n  left: 0;\n  bottom: 0;\n  width: 100%;\n  height: 84px;\n  display: flex;\n  position: fixed;\n  padding-top: 30px;\n  background: #fff;\n  align-items: center;\n  padding-bottom: 38px;\n  justify-content: space-around;\n  button {\n    float: left;\n    width: 302px;\n    height: 84px;\n    border: none;\n    outline: none;\n    color: #fff;\n    display: block;\n    font-size: 32px;\n    line-height: 84px;\n    text-align: center;\n    background: #fff;\n    border-radius: 8px;\n    font-family: PingFang SC;\n    background: rgba(39, 79, 243, 1);\n  }\n}\n</style>\n\n"],"sourceRoot":"src/module/marketing/edit"}]}