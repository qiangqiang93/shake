{"remainingRequest":"/Users/qiang/work/hytx/circle/node_modules/babel-loader/lib/index.js!/Users/qiang/work/hytx/circle/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/qiang/work/hytx/circle/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/qiang/work/hytx/circle/src/components/AppUploadImg/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/qiang/work/hytx/circle/src/components/AppUploadImg/index.vue","mtime":1546945930106},{"path":"/Users/qiang/work/hytx/circle/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/qiang/work/hytx/circle/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/qiang/work/hytx/circle/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/qiang/work/hytx/circle/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import _regeneratorRuntime from \"/Users/qiang/work/hytx/circle/node_modules/@babel/runtime/regenerator\";\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport Exif from 'exif-js';\nimport config from '../../config';\nimport { mapActions } from 'vuex';\nimport eventBus from '../../utils/eventBus';\nimport dialogService from '../../service/dialogService';\nexport default {\n  props: ['type', 'ratio'],\n  data: function data() {\n    return {\n      eventName: null,\n      // 当前组件事件名称\n      orientation: null // 旋转方向\n\n    };\n  },\n  mounted: function mounted() {\n    var _self = this;\n\n    _self.eventName = \"AppUploadEvent_\".concat(parseInt(Math.random() * 1000));\n    eventBus.$on(_self.eventName, function (path) {\n      _self.$emit('success', path);\n    });\n  },\n  methods: _objectSpread({}, mapActions(['system/updateCropper']), {\n    cropImg: function () {\n      var _cropImg = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(event) {\n        var file;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                file = event.target.files[0];\n\n                if (!(Math.round(file.size / 1024 / 1024) > config.MaxSize)) {\n                  _context.next = 4;\n                  break;\n                }\n\n                dialogService.alert(\"\\u8BF7\\u4E0A\\u4F20\".concat(config.MaxSize, \"M\\u4EE5\\u4E0B\\u7684\\u56FE\\u7247\"));\n                return _context.abrupt(\"return\", false);\n\n              case 4:\n                _context.next = 6;\n                return this.toBase64(file);\n\n              case 6:\n                file = _context.sent;\n                _context.next = 9;\n                return this.compress(file);\n\n              case 9:\n                file = _context.sent;\n                this['system/updateCropper']({\n                  file: file,\n                  ratio: this.ratio,\n                  eventName: this.eventName\n                });\n                this.$router.push({\n                  path: '/cropper'\n                });\n\n              case 12:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function cropImg(_x) {\n        return _cropImg.apply(this, arguments);\n      }\n\n      return cropImg;\n    }(),\n    // 将图片转化为base64\n    toBase64: function () {\n      var _toBase = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2(file) {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                return _context2.abrupt(\"return\", new Promise(function (resolve, reject) {\n                  var fileReader = new FileReader();\n                  fileReader.readAsDataURL(file);\n\n                  fileReader.onload = function (e) {\n                    resolve(e.target.result);\n                  };\n                }));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function toBase64(_x2) {\n        return _toBase.apply(this, arguments);\n      }\n\n      return toBase64;\n    }(),\n    // 压缩转换的base64\n    compress: function () {\n      var _compress = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(base64) {\n        var _self;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _self = this;\n                return _context3.abrupt(\"return\", new Promise(function (resolve, reject) {\n                  var img = new Image();\n                  img.src = base64;\n\n                  img.onload = function () {\n                    Exif.getData(img, function () {\n                      var context;\n                      var width = img.width;\n                      var height = img.height;\n                      var canvas = document.createElement('canvas');\n                      var orientation = Exif.getTag(img, 'Orientation'); // 旋转参数说明 https://baiyunliu.iteye.com/blog/2067000\n                      // 暂时仅解决 orientation 为6时的问题\n\n                      if (orientation === 6) {\n                        height = height > 750 ? 750 : height;\n                        width = img.height > 750 ? 750 / img.height * width : width;\n                        canvas.width = height;\n                        canvas.height = width;\n                        context = canvas.getContext('2d');\n                        context.translate(height / 2, width / 2);\n                        context.rotate(90 * Math.PI / 180);\n                        context.drawImage(img, -width / 2, -height / 2, width, height);\n                      } else {\n                        width = width > 750 ? 750 : width;\n                        height = img.width > 750 ? 750 / img.width * height : height;\n                        canvas.width = width;\n                        canvas.height = height;\n                        context = canvas.getContext('2d');\n                        context.drawImage(img, 0, 0, width, height);\n                      }\n\n                      base64 = canvas.toDataURL('image/jpeg', 0.8);\n                      resolve(base64);\n                    });\n                  };\n                }));\n\n              case 2:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function compress(_x3) {\n        return _compress.apply(this, arguments);\n      }\n\n      return compress;\n    }()\n  }),\n  destroyed: function destroyed() {\n    eventBus.$off(this.eventName);\n  }\n};",{"version":3,"sources":["index.vue"],"names":[],"mappings":"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","sourcesContent":["<!--\n    @name       AppUploadImg\n    @desc       文件上传组件\n    @props  \n        ratio   number              图片比例\n        success function            上传成功之后的回调函数\n-->\n\n<template>\n  <input type=\"file\" accept=\"image/*\" @change=\"cropImg($event)\">\n</template>\n\n<script>\nimport Exif from 'exif-js'\nimport config from '../../config'\nimport { mapActions } from 'vuex'\nimport eventBus from '../../utils/eventBus'\nimport dialogService from '../../service/dialogService'\n\nexport default {\n  props: ['type', 'ratio'],\n  data() {\n    return {\n      eventName: null, // 当前组件事件名称\n      orientation: null // 旋转方向\n    }\n  },\n  mounted() {\n    let _self = this\n    _self.eventName = `AppUploadEvent_${parseInt(Math.random() * 1000)}`\n    eventBus.$on(_self.eventName, function(path) {\n      _self.$emit('success', path)\n    })\n  },\n  methods: {\n    ...mapActions(['system/updateCropper']),\n    async cropImg(event) {\n      let file = event.target.files[0]\n      if (Math.round(file.size / 1024 / 1024) > config.MaxSize) {\n        dialogService.alert(`请上传${config.MaxSize}M以下的图片`)\n        return false\n      }\n      file = await this.toBase64(file)\n      file = await this.compress(file)\n      this['system/updateCropper']({\n        file: file,\n        ratio: this.ratio,\n        eventName: this.eventName\n      })\n      this.$router.push({ path: '/cropper' })\n    },\n    // 将图片转化为base64\n    async toBase64(file) {\n      return new Promise((resolve, reject) => {\n        let fileReader = new FileReader()\n        fileReader.readAsDataURL(file)\n        fileReader.onload = function(e) {\n          resolve(e.target.result)\n        }\n      })\n    },\n    // 压缩转换的base64\n    async compress(base64) {\n      let _self = this\n      return new Promise((resolve, reject) => {\n        let img = new Image()\n        img.src = base64\n        img.onload = function() {\n          Exif.getData(img, function() {\n            let context\n            let width = img.width\n            let height = img.height\n            let canvas = document.createElement('canvas')\n            let orientation = Exif.getTag(img, 'Orientation')\n            // 旋转参数说明 https://baiyunliu.iteye.com/blog/2067000\n            // 暂时仅解决 orientation 为6时的问题\n            if (orientation === 6) {\n              height = height > 750 ? 750 : height\n              width = img.height > 750 ? (750 / img.height) * width : width\n              canvas.width = height\n              canvas.height = width\n              context = canvas.getContext('2d')\n              context.translate(height / 2, width / 2)\n              context.rotate((90 * Math.PI) / 180)\n              context.drawImage(img, -width / 2, -height / 2, width, height)\n            } else {\n              width = width > 750 ? 750 : width\n              height = img.width > 750 ? (750 / img.width) * height : height\n              canvas.width = width\n              canvas.height = height\n              context = canvas.getContext('2d')\n              context.drawImage(img, 0, 0, width, height)\n            }\n            base64 = canvas.toDataURL('image/jpeg', 0.8)\n            resolve(base64)\n          })\n        }\n      })\n    }\n  },\n  destroyed() {\n    eventBus.$off(this.eventName)\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n</style>\n"],"sourceRoot":"src/components/AppUploadImg"}]}